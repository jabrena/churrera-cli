@startuml
!theme plain
scale 0.6
title Churrera CLI Module - Class Diagram

package "info.jab.churrera.cli" {
  class ChurreraCLI {
    - CursorApiKeyResolver apiKeyResolver
    - PropertyResolver propertyResolver
    - JobRepository jobRepository
    - ApiClient apiClient
    - DefaultApi defaultApi
    - CLIAgent cliAgent
    - WorkflowParser workflowParser
    - JobProcessor jobProcessor
    - WorkflowValidator workflowValidator
    - PmlValidator pmlValidator
    - String apiKey
    + main(String[] args)
    + createRunCmd() : RunCommand
    + run()
    - printBanner(Supplier<GitInfo>)
  }
}

package "info.jab.churrera.cli.command.cli" {
  class CliCommand {
    - JobRepository jobRepository
    - JobProcessor jobProcessor
    - PropertyResolver propertyResolver
    - Scanner scanner
    - CLIAgent cliAgent
    + run()
  }
  
  class JobsCommand {
    - JobRepository jobRepository
    + run()
  }
  
  class NewJobCommand {
    - JobRepository jobRepository
    - JobProcessor jobProcessor
    + run()
  }
  
  class NewJobRunCommand {
    - JobRepository jobRepository
    - JobProcessor jobProcessor
    + run()
  }
  
  class JobStatusCommand {
    - JobRepository jobRepository
    + run()
  }
  
  class JobLogsCommand {
    - JobRepository jobRepository
    + run()
  }
  
  class DeleteJobCommand {
    - JobRepository jobRepository
    + run()
  }
  
  class JobsPrCommand {
    - JobRepository jobRepository
    + run()
  }
  
  class TableFormatter {
    + formatJobs(List<Job>)
  }
}

package "info.jab.churrera.cli.command.run" {
  interface CompletionChecker {
    + checkCompletion(Job) : CompletionCheckResult
  }
  
  class SimpleWorkflowCompletionChecker {
    + checkCompletion(Job) : CompletionCheckResult
  }
  
  class ParallelWorkflowCompletionChecker {
    + checkCompletion(Job) : CompletionCheckResult
  }
  
  class CompletionCheckerFactory {
    + create(WorkflowType) : CompletionChecker
  }
  
  class RunCommand {
    - JobRepository jobRepository
    - JobProcessor jobProcessor
    - WorkflowValidator workflowValidator
    - WorkflowParser workflowParser
    - PmlValidator pmlValidator
    - int pollingIntervalSeconds
    - CLIAgent cliAgent
    + call() : Integer
  }
  
  class JobCreationService {
    - JobRepository jobRepository
    - WorkflowParser workflowParser
    + createJob(String, String, String) : JobCreationResult
  }
  
  class JobDeletionService {
    - JobRepository jobRepository
    + deleteJob(String)
  }
  
  class JobDisplayService {
    - JobRepository jobRepository
    + displayJob(String)
    + displayJobs()
  }
  
  class JobPollingService {
    - JobRepository jobRepository
    - JobProcessor jobProcessor
    + pollJobs()
  }
  
  class ExecutionResult {
    + int exitCode
    + String message
  }
  
  class JobCreationResult {
    + String jobId
    + boolean success
  }
  
  class CompletionCheckResult {
    + boolean isComplete
    + AgentState finalState
  }
}

package "info.jab.churrera.cli.model" {
  class Job {
    + String jobId
    + String path
    + String cursorAgentId
    + String model
    + String repository
    + AgentState status
    + LocalDateTime createdAt
    + LocalDateTime lastUpdate
    + String parentJobId
    + String result
    + WorkflowType type
    + Long timeoutMillis
    + LocalDateTime workflowStartTime
    + String fallbackSrc
    + Boolean fallbackExecuted
    + withPath(String) : Job
    + withCursorAgentId(String) : Job
    + withStatus(AgentState) : Job
  }
  
  class JobWithDetails {
    - Job job
    - List<Prompt> prompts
    + getJob() : Job
    + getPrompts() : List<Prompt>
  }
  
  class Prompt {
    + String promptId
    + String jobId
    + String content
    + String status
    + LocalDateTime createdAt
    + withStatus(String) : Prompt
  }
  
  enum AgentState {
    CREATING
    RUNNING
    COMPLETED
    FAILED
    + isTerminal() : boolean
    + of(AgentResponse) : AgentState
  }
}

package "info.jab.churrera.cli.repository" {
  class JobRepository {
    - Context context
    - String databasePath
    + findAll() : List<Job>
    + findById(String) : Optional<Job>
    + save(Job)
    + deleteById(String)
    + savePrompt(Prompt)
    + findPromptById(String) : Optional<Prompt>
    + findPromptsByJobId(String) : List<Prompt>
    + findJobWithDetails(String) : Optional<JobWithDetails>
    + findUnfinishedJobs() : List<Job>
    + findJobsByParentId(String) : List<Job>
    + close()
  }
}

package "info.jab.churrera.cli.service" {
  class CLIAgent {
    - CursorAgentManagement cursorAgentManagement
    - CursorAgentInformation cursorAgentInformation
    - CursorAgentGeneralEndpoints cursorAgentGeneralEndpoints
    - JobRepository jobRepository
    - PmlConverter pmlConverter
    + launchAgentForJob(Job, String, String, String, boolean) : String
    + followUpForPrompt(String, String, String, String) : String
    + monitorAgent(String, int) : AgentState
    + getConversation(String) : ConversationResponse
    + getConversationContent(String) : String
    + deleteAgent(String)
    + updateJobCursorIdInDatabase(Job, String, AgentState)
    + updateJobStatusInDatabase(Job, AgentState)
    + updatePromptInDatabase(Prompt, String)
    + getAgentStatus(String) : AgentState
    + getModels() : List<String>
    + getRepositories() : List<String>
  }
  
  class JobProcessor {
    - JobRepository jobRepository
    - WorkflowFileService workflowFileService
    - SequenceWorkflowHandler sequenceWorkflowHandler
    - ParallelWorkflowHandler parallelWorkflowHandler
    - ChildWorkflowHandler childWorkflowHandler
    + processJobs()
    - processJob(Job)
    - processJobWorkflow(Job, List<Prompt>)
  }
  
  class AgentLauncher {
    - CLIAgent cliAgent
    - JobRepository jobRepository
    - WorkflowFileService workflowFileService
    + launchAgent(Job, String, String, String, boolean) : String
  }
  
  class PromptProcessor {
    - CLIAgent cliAgent
    - WorkflowFileService workflowFileService
    + processPrompt(Job, Prompt, String) : String
  }
  
  class ResultExtractor {
    - CLIAgent cliAgent
    - JobRepository jobRepository
    + extractResult(String) : String
  }
  
  class TimeoutManager {
    - JobRepository jobRepository
    + checkTimeout(Job) : boolean
    + handleTimeout(Job)
  }
  
  class FallbackExecutor {
    - CLIAgent cliAgent
    - JobRepository jobRepository
    - WorkflowFileService workflowFileService
    + executeFallback(Job)
  }
  
  class WorkflowFileService {
    - WorkflowParser workflowParser
    + parseWorkflow(String) : WorkflowData
    + readPromptFile(String) : String
  }
}

package "info.jab.churrera.cli.service.handler" {
  class SequenceWorkflowHandler {
    - JobRepository jobRepository
    - CLIAgent cliAgent
    - AgentLauncher agentLauncher
    - PromptProcessor promptProcessor
    - TimeoutManager timeoutManager
    - FallbackExecutor fallbackExecutor
    + processWorkflow(Job, List<Prompt>, WorkflowData)
  }
  
  class ParallelWorkflowHandler {
    - JobRepository jobRepository
    - CLIAgent cliAgent
    - AgentLauncher agentLauncher
    - TimeoutManager timeoutManager
    - FallbackExecutor fallbackExecutor
    - ResultExtractor resultExtractor
    + processWorkflow(Job, WorkflowData)
  }
  
  class ChildWorkflowHandler {
    - JobRepository jobRepository
    - CLIAgent cliAgent
    - AgentLauncher agentLauncher
    - PromptProcessor promptProcessor
    - TimeoutManager timeoutManager
    - FallbackExecutor fallbackExecutor
    + processWorkflow(Job, WorkflowData, List<Prompt>)
  }
}

package "info.jab.churrera.cli.util" {
  class GitInfo {
    + print()
  }
  
  class JobXmlMapper {
    + fromDocument(String, DateTimeFormatter) : List<Job>
    + toXml(Job, DateTimeFormatter) : String
  }
  
  class PromptXmlMapper {
    + fromDocument(String, DateTimeFormatter) : List<Prompt>
    + toXml(Prompt, DateTimeFormatter) : String
  }
  
  class XmlUtils {
    + formatXml(String) : String
  }
}

' Relationships
ChurreraCLI --> JobRepository
ChurreraCLI --> CLIAgent
ChurreraCLI --> JobProcessor
ChurreraCLI --> WorkflowParser
ChurreraCLI --> WorkflowValidator
ChurreraCLI --> PmlValidator

CliCommand --> JobRepository
CliCommand --> JobProcessor
CliCommand --> CLIAgent

RunCommand --> JobRepository
RunCommand --> JobProcessor
RunCommand --> CLIAgent
RunCommand --> WorkflowParser
RunCommand --> WorkflowValidator

JobProcessor --> JobRepository
JobProcessor --> CLIAgent
JobProcessor --> SequenceWorkflowHandler
JobProcessor --> ParallelWorkflowHandler
JobProcessor --> ChildWorkflowHandler
JobProcessor --> WorkflowFileService

CLIAgent --> JobRepository
CLIAgent --> CursorAgentManagement
CLIAgent --> CursorAgentInformation
CLIAgent --> CursorAgentGeneralEndpoints
CLIAgent --> PmlConverter

SequenceWorkflowHandler --> JobRepository
SequenceWorkflowHandler --> CLIAgent
SequenceWorkflowHandler --> AgentLauncher
SequenceWorkflowHandler --> PromptProcessor

ParallelWorkflowHandler --> JobRepository
ParallelWorkflowHandler --> CLIAgent
ParallelWorkflowHandler --> AgentLauncher
ParallelWorkflowHandler --> ResultExtractor

ChildWorkflowHandler --> JobRepository
ChildWorkflowHandler --> CLIAgent
ChildWorkflowHandler --> AgentLauncher

JobRepository --> Job
JobRepository --> Prompt
JobRepository --> JobWithDetails

SimpleWorkflowCompletionChecker ..|> CompletionChecker
ParallelWorkflowCompletionChecker ..|> CompletionChecker
CompletionCheckerFactory --> CompletionChecker

Job --> AgentState
Job --> WorkflowType
JobWithDetails --> Job
JobWithDetails --> Prompt

@enduml
