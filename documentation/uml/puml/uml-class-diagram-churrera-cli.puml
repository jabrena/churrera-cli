@startuml
!theme plain
title Churrera CLI Module - Class Diagram

package "info.jab.churrera.cli" {
  class ChurreraCLI {
    -logger: Logger
    +main(String[]): void
    +createCLICommand(): CliCommand
    +createRunCommand(): RunCommand
    -printBanner(): void
  }
}

package "info.jab.churrera.cli.command" {
  class CliCommand {
    -jobRepository: JobRepository
    -jobProcessor: JobProcessor
    -propertyResolver: PropertyResolver
    -scanner: Scanner
    -cliAgent: CLIAgent
    -scheduledExecutor: ScheduledExecutorService
    +run(): void
    -executeCommand(String): void
    -printHelp(): void
    -isExitCommand(String): boolean
    -clearScreen(): void
    +getScheduledExecutor(): ScheduledExecutorService
    +getJobRepository(): JobRepository
  }

  class RunCommand {
    -jobRepository: JobRepository
    -jobProcessor: JobProcessor
    -workflowValidator: WorkflowValidator
    -workflowParser: WorkflowParser
    -pmlValidator: PmlValidator
    -pollingIntervalSeconds: int
    +run(): void
  }

  class JobsCommand {
    -jobRepository: JobRepository
    +run(): void
  }

  class NewJobCommand {
    -jobRepository: JobRepository
    -jobPath: String
    +run(): void
  }

  class NewJobRunCommand {
    -jobRepository: JobRepository
    -jobPath: String
    -workflowValidator: WorkflowValidator
    -workflowParser: WorkflowParser
    -pmlValidator: PmlValidator
    +run(): void
  }

  class JobsPrCommand {
    -jobRepository: JobRepository
    -jobId: String
    +run(): void
  }

  class JobStatusCommand {
    -jobRepository: JobRepository
    -cliAgent: CLIAgent
    -jobId: String
    +run(): void
  }

  class JobLogsCommand {
    -jobRepository: JobRepository
    -cliAgent: CLIAgent
    -jobId: String
    +run(): void
  }

  class DeleteJobCommand {
    -jobRepository: JobRepository
    -cliAgent: CLIAgent
    -jobId: String
    +run(): void
  }

  class TableFormatter {
    +formatJobs(List<Job>): String
    +formatJobDetails(JobWithDetails): String
  }
}

package "info.jab.churrera.cli.service" {
  class CLIAgent {
    -cursorAgentManagement: CursorAgentManagement
    -cursorAgentInformation: CursorAgentInformation
    -jobRepository: JobRepository
    -pmlConverter: PmlConverter
    -propertyResolver: PropertyResolver
    +launchAgentForJob(Job, String, String, String, boolean): String
    +followUpForPrompt(String, String, String, String): String
    +monitorAgent(String, int): AgentState
    +getConversation(String): ConversationResponse
    +getConversationContent(String): String
    +deleteAgent(String): void
    +updateJobCursorIdInDatabase(Job, String, AgentState): void
    +updateJobStatusInDatabase(Job, AgentState): void
    +updatePromptInDatabase(Prompt, String): void
    +updateJobInDatabase(Job): void
    +getAgentStatus(String): AgentState
    -convertToMarkdown(String, String): String
  }

  class JobProcessor {
    -jobRepository: JobRepository
    -cliAgent: CLIAgent
    -workflowParser: WorkflowParser
    -pollingIntervalSeconds: int
    +processJobs(): void
    -processJob(Job): void
    -processJobWorkflow(Job, List<Prompt>): void
    -processChildJobWorkflow(Job, WorkflowData, List<Prompt>): void
    -processParallelWorkflow(Job, WorkflowData): void
    -createChildJobs(Job, List<Object>, ParallelWorkflowData): void
    -createChildJobPrompts(Job, SequenceInfo): void
    -launchJobAgent(Job, WorkflowData): void
    -monitorAndProcessPrompts(Job, List<Prompt>, WorkflowData): void
    -processRemainingPrompts(Job, List<Prompt>, WorkflowData): void
    -processPrompt(Job, Prompt, PromptInfo): void
    -parseWorkflow(String): WorkflowData
    -readPromptFile(String, String): String
    -executeFallback(Job, WorkflowData, long, long): void
    -executeFallbackForParallelChildren(Job, ParallelWorkflowData): void
    -inferTypeFromExtension(String): String
  }
}

package "info.jab.churrera.cli.repository" {
  class JobRepository {
    -context: Context
    -databasePath: String
    -initialized: boolean
    +initialize(): void
    +findAll(): List<Job>
    +findById(String): Optional<Job>
    +save(Job): void
    +deleteById(String): void
    +savePrompt(Prompt): void
    +findPromptById(String): Optional<Prompt>
    +findPromptsByJobId(String): List<Prompt>
    +findJobWithDetails(String): Optional<JobWithDetails>
    +findUnfinishedJobs(): List<Job>
    +deletePromptsByJobId(String): void
    +findJobsByParentId(String): List<Job>
    +close(): void
    -jobToXml(Job): String
    -parseJobFromXml(String): Job
    -parseJobsFromDocument(String): List<Job>
    -promptToXml(Prompt): String
    -parsePromptFromXml(String): Prompt
    -parsePromptsFromDocument(String): List<Prompt>
    -escapeXml(String): String
  }
}

package "info.jab.churrera.cli.model" {
  class Job {
    +jobId: String
    +path: String
    +cursorAgentId: String
    +model: String
    +repository: String
    +status: AgentState
    +createdAt: LocalDateTime
    +lastUpdate: LocalDateTime
    +parentJobId: String
    +result: String
    +type: WorkflowType
    +timeoutMillis: Long
    +workflowStartTime: LocalDateTime
    +fallbackSrc: String
    +fallbackExecuted: Boolean
    +withPath(String): Job
    +withCursorAgentId(String): Job
    +withStatus(AgentState): Job
    +withModel(String): Job
    +withRepository(String): Job
    +withParentJobId(String): Job
    +withResult(String): Job
    +withType(WorkflowType): Job
    +withTimeoutMillis(Long): Job
    +withWorkflowStartTime(LocalDateTime): Job
    +withFallbackSrc(String): Job
    +withFallbackExecuted(Boolean): Job
  }

  class JobWithDetails {
    -job: Job
    -prompts: List<Prompt>
    +getJob(): Job
    +getPrompts(): List<Prompt>
  }

  class Prompt {
    +promptId: String
    +jobId: String
    +pmlFile: String
    +status: String
    +createdAt: LocalDateTime
    +lastUpdate: LocalDateTime
    +withStatus(String): Prompt
  }

  enum AgentState {
    UNKNOWN
    CREATING
    ACTIVE
    SUCCESSFUL
    FAILED
    +isTerminal(): boolean
    +isActive(): boolean
    +isSuccessful(): boolean
    +of(AgentResponse): AgentState
  }
}

package "info.jab.churrera.cli.util" {
  class GitInfo {
    +print(): void
  }
}

' Relationships
ChurreraCLI --> CliCommand : creates
ChurreraCLI --> RunCommand : creates
CliCommand --> JobRepository : uses
CliCommand --> JobProcessor : uses
CliCommand --> CLIAgent : uses
CliCommand --> PropertyResolver : uses
RunCommand --> JobRepository : uses
RunCommand --> JobProcessor : uses
RunCommand --> WorkflowValidator : uses
RunCommand --> WorkflowParser : uses
RunCommand --> PmlValidator : uses
JobsCommand --> JobRepository : uses
NewJobCommand --> JobRepository : uses
NewJobRunCommand --> JobRepository : uses
NewJobRunCommand --> WorkflowValidator : uses
NewJobRunCommand --> WorkflowParser : uses
NewJobRunCommand --> PmlValidator : uses
JobStatusCommand --> JobRepository : uses
JobStatusCommand --> CLIAgent : uses
JobLogsCommand --> JobRepository : uses
JobLogsCommand --> CLIAgent : uses
DeleteJobCommand --> JobRepository : uses
DeleteJobCommand --> CLIAgent : uses
CLIAgent --> JobRepository : uses
CLIAgent --> CursorAgentManagement : uses
CLIAgent --> CursorAgentInformation : uses
CLIAgent --> PmlConverter : uses
CLIAgent --> PropertyResolver : uses
JobProcessor --> JobRepository : uses
JobProcessor --> CLIAgent : uses
JobProcessor --> WorkflowParser : uses
JobRepository --> Job : manages
JobRepository --> Prompt : manages
JobRepository --> JobWithDetails : creates
JobWithDetails --> Job : contains
JobWithDetails --> Prompt : contains
Job --> AgentState : uses
Job --> WorkflowType : uses
Prompt --> Job : references

@enduml
