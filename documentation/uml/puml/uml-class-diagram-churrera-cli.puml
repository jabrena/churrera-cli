@startuml
!theme plain
left to right direction
scale 0.6
title Churrera CLI Module - Class Diagram

package "info.jab.churrera.cli" {
  class ChurreraCLI implements Runnable {
    - CursorApiKeyResolver apiKeyResolver
    - PropertyResolver propertyResolver
    - JobRepository jobRepository
    - ApiClient apiClient
    - DefaultApi defaultApi
    - CLIAgent cliAgent
    - WorkflowParser workflowParser
    - JobProcessor jobProcessor
    - WorkflowValidator workflowValidator
    - PmlValidator pmlValidator
    - String apiKey
    + ChurreraCLI()
    + createRunCmd() : RunCommand
    + run()
    + {static} main(String[] args)
    + {static} printBanner(Supplier<GitInfo>)
  }
}

package "info.jab.churrera.cli.command.cli" {
  class CliCommand implements Runnable {
    - JobRepository jobRepository
    - JobProcessor jobProcessor
    - PropertyResolver propertyResolver
    - Scanner scanner
    - CLIAgent cliAgent
    - ScheduledExecutorService scheduledExecutor
    + CliCommand(...)
    + run()
    - executeCommand(String)
    - printHelp()
    - isExitCommand(String) : boolean
    - clearScreen()
    + getScheduledExecutor() : ScheduledExecutorService
    + getJobRepository() : JobRepository
  }

  class JobsCommand implements Runnable {
    - JobRepository jobRepository
    + JobsCommand(JobRepository)
    + run()
  }

  class NewJobCommand implements Runnable {
    - JobRepository jobRepository
    - String jobPath
    + NewJobCommand(...)
    + run()
  }

  class NewJobRunCommand implements Runnable {
    - JobRepository jobRepository
    - String jobPath
    - WorkflowValidator workflowValidator
    - WorkflowParser workflowParser
    - PmlValidator pmlValidator
    + NewJobRunCommand(...)
    + run()
  }

  class JobStatusCommand implements Runnable {
    - JobRepository jobRepository
    - CLIAgent cliAgent
    - String jobId
    + JobStatusCommand(...)
    + run()
  }

  class JobLogsCommand implements Runnable {
    - JobRepository jobRepository
    - CLIAgent cliAgent
    - String jobId
    + JobLogsCommand(...)
    + run()
  }

  class JobsPrCommand implements Runnable {
    - JobRepository jobRepository
    - String jobId
    + JobsPrCommand(...)
    + run()
  }

  class DeleteJobCommand implements Runnable {
    - JobRepository jobRepository
    - CLIAgent cliAgent
    - String jobId
    + DeleteJobCommand(...)
    + run()
  }

  class TableFormatter {
    + formatJobsTable(List<Job>) : String
  }
}

package "info.jab.churrera.cli.command.run" {
  class RunCommand implements Callable<Integer> {
    - JobRepository jobRepository
    - JobProcessor jobProcessor
    - WorkflowValidator workflowValidator
    - WorkflowParser workflowParser
    - PmlValidator pmlValidator
    - int pollingIntervalSeconds
    - CLIAgent cliAgent
    + RunCommand(...)
    + call() : Integer
  }

  interface CompletionChecker {
    + checkCompletion(Job) : CompletionCheckResult
  }

  class SimpleWorkflowCompletionChecker implements CompletionChecker {
    + checkCompletion(Job) : CompletionCheckResult
  }

  class ParallelWorkflowCompletionChecker implements CompletionChecker {
    - JobRepository jobRepository
    + ParallelWorkflowCompletionChecker(JobRepository)
    + checkCompletion(Job) : CompletionCheckResult
  }

  class CompletionCheckerFactory {
    + {static} create(WorkflowType, JobRepository) : CompletionChecker
  }

  class CompletionCheckResult {
    + boolean isComplete
    + String message
  }

  class JobCreationService {
    - JobRepository jobRepository
    - WorkflowValidator workflowValidator
    - WorkflowParser workflowParser
    - PmlValidator pmlValidator
    + JobCreationService(...)
    + createJob(String) : JobCreationResult
  }

  class JobCreationResult {
    + Job job
    + boolean success
    + String errorMessage
  }

  class JobPollingService {
    - JobRepository jobRepository
    - JobProcessor jobProcessor
    - CompletionChecker completionChecker
    - int pollingIntervalSeconds
    + JobPollingService(...)
    + pollUntilComplete(Job) : ExecutionResult
  }

  class JobDisplayService {
    + displayJobStatus(Job, CLIAgent)
    + displayJobLogs(Job, CLIAgent)
  }

  class JobDeletionService {
    - JobRepository jobRepository
    - CLIAgent cliAgent
    + JobDeletionService(...)
    + deleteJob(String)
  }

  class ExecutionResult {
    + boolean success
    + String message
    + AgentState finalStatus
  }
}

package "info.jab.churrera.cli.model" {
  class Job <<record>> {
    + String jobId
    + String path
    + String cursorAgentId
    + String model
    + String repository
    + AgentState status
    + LocalDateTime createdAt
    + LocalDateTime lastUpdate
    + String parentJobId
    + String result
    + WorkflowType type
    + Long timeoutMillis
    + LocalDateTime workflowStartTime
    + String fallbackSrc
    + Boolean fallbackExecuted
    + withPath(String) : Job
    + withCursorAgentId(String) : Job
    + withStatus(AgentState) : Job
    + withModel(String) : Job
    + withRepository(String) : Job
    + withParentJobId(String) : Job
    + withResult(String) : Job
    + withType(WorkflowType) : Job
    + withTimeoutMillis(Long) : Job
    + withWorkflowStartTime(LocalDateTime) : Job
    + withFallbackSrc(String) : Job
    + withFallbackExecuted(Boolean) : Job
  }

  class Prompt <<record>> {
    + String promptId
    + String jobId
    + String pmlFile
    + String status
    + LocalDateTime createdAt
    + LocalDateTime lastUpdate
    + withStatus(String) : Prompt
    + withPmlFile(String) : Prompt
  }

  class JobWithDetails {
    - Job job
    - List<Prompt> prompts
    + JobWithDetails(Job, List<Prompt>)
    + getJob() : Job
    + getPrompts() : List<Prompt>
  }

  class AgentState {
    - AgentStatus status
    + {static} of(AgentResponse) : AgentState
    + {static} of(AgentStatus) : AgentState
    + {static} of(String) : AgentState
    + {static} CREATING() : AgentState
    + {static} RUNNING() : AgentState
    + {static} FINISHED() : AgentState
    + {static} ERROR() : AgentState
    + {static} EXPIRED() : AgentState
    + getStatus() : AgentStatus
    + isTerminal() : boolean
    + isSuccessful() : boolean
    + isFailed() : boolean
    + isActive() : boolean
  }
}

package "info.jab.churrera.cli.repository" {
  class JobRepository {
    - Context context
    - String databasePath
    + JobRepository(PropertyResolver)
    - initialize()
    + findAll() : List<Job>
    + findById(String) : Optional<Job>
    + save(Job)
    + deleteById(String)
    + savePrompt(Prompt)
    + findPromptById(String) : Optional<Prompt>
    + findPromptsByJobId(String) : List<Prompt>
    + findJobWithDetails(String) : Optional<JobWithDetails>
    + findUnfinishedJobs() : List<Job>
    + deletePromptsByJobId(String)
    + findJobsByParentId(String) : List<Job>
    + close()
  }
}

package "info.jab.churrera.cli.service" {
  class CLIAgent {
    - CursorAgentManagement cursorAgentManagement
    - CursorAgentInformation cursorAgentInformation
    - CursorAgentGeneralEndpoints cursorAgentGeneralEndpoints
    - JobRepository jobRepository
    - PmlConverter pmlConverter
    - PropertyResolver propertyResolver
    + CLIAgent(...)
    + launchAgentForJob(Job, String, String, String, boolean) : String
    + followUpForPrompt(String, String, String, String) : String
    + monitorAgent(String, int) : AgentState
    + getConversation(String) : ConversationResponse
    + getConversationContent(String) : String
    + deleteAgent(String)
    + updateJobCursorIdInDatabase(Job, String, AgentState)
    + updateJobStatusInDatabase(Job, AgentState)
    + updatePromptInDatabase(Prompt, String)
    + updateJobInDatabase(Job)
    + getAgentStatus(String) : AgentState
    + getModels() : List<String>
    + getRepositories() : List<String>
    - convertToMarkdown(String, String) : String
  }

  class JobProcessor {
    - JobRepository jobRepository
    - WorkflowFileService workflowFileService
    - SequenceWorkflowHandler sequenceWorkflowHandler
    - ParallelWorkflowHandler parallelWorkflowHandler
    - ChildWorkflowHandler childWorkflowHandler
    + JobProcessor(JobRepository, CLIAgent, WorkflowParser, int)
    + processJobs()
    - processJob(Job)
    - processJobWorkflow(Job, List<Prompt>)
  }

  class AgentLauncher {
    - CLIAgent cliAgent
    - JobRepository jobRepository
    - WorkflowFileService workflowFileService
    - TimeoutManager timeoutManager
    + AgentLauncher(...)
    + launchAgent(Job, PromptInfo, String) : String
  }

  class PromptProcessor {
    - CLIAgent cliAgent
    - WorkflowFileService workflowFileService
    + PromptProcessor(CLIAgent, WorkflowFileService)
    + processPrompt(Job, PromptInfo, String) : String
  }

  class ResultExtractor {
    - CLIAgent cliAgent
    - JobRepository jobRepository
    + ResultExtractor(CLIAgent, JobRepository)
    + extractResult(Job) : String
  }

  class TimeoutManager {
    - JobRepository jobRepository
    + TimeoutManager(JobRepository)
    + checkTimeout(Job) : boolean
    + markTimeout(Job)
  }

  class FallbackExecutor {
    - CLIAgent cliAgent
    - JobRepository jobRepository
    - WorkflowFileService workflowFileService
    - AgentLauncher agentLauncher
    + FallbackExecutor(...)
    + executeFallback(Job)
  }

  class WorkflowFileService {
    - WorkflowParser workflowParser
    + WorkflowFileService(WorkflowParser)
    + parseWorkflow(String) : WorkflowData
  }
}

package "info.jab.churrera.cli.service.handler" {
  class SequenceWorkflowHandler {
    - JobRepository jobRepository
    - CLIAgent cliAgent
    - AgentLauncher agentLauncher
    - PromptProcessor promptProcessor
    - TimeoutManager timeoutManager
    - FallbackExecutor fallbackExecutor
    + SequenceWorkflowHandler(...)
    + processWorkflow(Job, List<Prompt>, WorkflowData)
  }

  class ParallelWorkflowHandler {
    - JobRepository jobRepository
    - CLIAgent cliAgent
    - AgentLauncher agentLauncher
    - TimeoutManager timeoutManager
    - FallbackExecutor fallbackExecutor
    - ResultExtractor resultExtractor
    + ParallelWorkflowHandler(...)
    + processWorkflow(Job, WorkflowData)
  }

  class ChildWorkflowHandler {
    - JobRepository jobRepository
    - CLIAgent cliAgent
    - AgentLauncher agentLauncher
    - PromptProcessor promptProcessor
    - TimeoutManager timeoutManager
    - FallbackExecutor fallbackExecutor
    + ChildWorkflowHandler(...)
    + processWorkflow(Job, WorkflowData, List<Prompt>)
  }
}

package "info.jab.churrera.cli.util" {
  class GitInfo {
    + print()
  }

  class JobXmlMapper {
    + {static} toXml(Job, DateTimeFormatter) : String
    + {static} fromDocument(String, DateTimeFormatter) : List<Job>
  }

  class PromptXmlMapper {
    + {static} toXml(Prompt, DateTimeFormatter) : String
    + {static} fromDocument(String, DateTimeFormatter) : List<Prompt>
  }

  class XmlUtils {
    + {static} methods
  }
}

' Relationships
ChurreraCLI --> JobRepository
ChurreraCLI --> CLIAgent
ChurreraCLI --> JobProcessor
ChurreraCLI --> WorkflowParser
ChurreraCLI --> WorkflowValidator
ChurreraCLI --> PmlValidator
ChurreraCLI --> RunCommand
ChurreraCLI --> CliCommand

CliCommand --> JobRepository
CliCommand --> JobProcessor
CliCommand --> CLIAgent
CliCommand --> JobsCommand
CliCommand --> NewJobRunCommand
CliCommand --> JobStatusCommand
CliCommand --> JobLogsCommand
CliCommand --> JobsPrCommand
CliCommand --> DeleteJobCommand

RunCommand --> JobRepository
RunCommand --> JobProcessor
RunCommand --> JobPollingService
RunCommand --> JobCreationService
RunCommand --> JobDisplayService
RunCommand --> JobDeletionService

JobPollingService --> CompletionChecker
JobPollingService --> JobRepository
JobPollingService --> JobProcessor

CompletionCheckerFactory ..> CompletionChecker : creates
SimpleWorkflowCompletionChecker ..|> CompletionChecker
ParallelWorkflowCompletionChecker ..|> CompletionChecker

JobRepository --> Job
JobRepository --> Prompt
JobRepository --> JobWithDetails

CLIAgent --> CursorAgentManagement
CLIAgent --> CursorAgentInformation
CLIAgent --> CursorAgentGeneralEndpoints
CLIAgent --> JobRepository
CLIAgent --> PmlConverter
CLIAgent --> Job
CLIAgent --> Prompt
CLIAgent --> AgentState

JobProcessor --> JobRepository
JobProcessor --> WorkflowFileService
JobProcessor --> SequenceWorkflowHandler
JobProcessor --> ParallelWorkflowHandler
JobProcessor --> ChildWorkflowHandler

SequenceWorkflowHandler --> CLIAgent
SequenceWorkflowHandler --> AgentLauncher
SequenceWorkflowHandler --> PromptProcessor
SequenceWorkflowHandler --> TimeoutManager
SequenceWorkflowHandler --> FallbackExecutor

ParallelWorkflowHandler --> CLIAgent
ParallelWorkflowHandler --> AgentLauncher
ParallelWorkflowHandler --> TimeoutManager
ParallelWorkflowHandler --> FallbackExecutor
ParallelWorkflowHandler --> ResultExtractor

ChildWorkflowHandler --> CLIAgent
ChildWorkflowHandler --> AgentLauncher
ChildWorkflowHandler --> PromptProcessor
ChildWorkflowHandler --> TimeoutManager
ChildWorkflowHandler --> FallbackExecutor

AgentLauncher --> CLIAgent
AgentLauncher --> WorkflowFileService
AgentLauncher --> TimeoutManager

PromptProcessor --> CLIAgent
PromptProcessor --> WorkflowFileService

ResultExtractor --> CLIAgent
ResultExtractor --> JobRepository

FallbackExecutor --> CLIAgent
FallbackExecutor --> AgentLauncher

WorkflowFileService --> WorkflowParser

Job --> AgentState
Job --> WorkflowType
JobWithDetails --> Job
JobWithDetails --> Prompt

AgentState --> AgentStatus

note right of ChurreraCLI
  Main CLI application entry point
end note

note right of JobProcessor
  Background processor for unfinished jobs
end note

note right of CLIAgent
  Service for managing Cursor agents
end note

@enduml
