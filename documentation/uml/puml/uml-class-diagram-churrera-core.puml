@startuml
!theme plain
scale 0.6
title Churrera Core Module - Class Diagram

package "info.jab.churrera.workflow" {
  class WorkflowParser {
    - Logger logger
    + parse(File) : WorkflowData
    + parse(Path) : WorkflowData
    + determineWorkflowType(File) : WorkflowType
    - parseV2Workflow(Node) : WorkflowData
    - parseParallelWorkflow(Element) : WorkflowData
    - parseSequenceInfo(Element) : SequenceInfo
    - inferTypeFromExtension(String) : String
  }
  
  class WorkflowData {
    - PromptInfo launchPrompt
    - String model
    - String repository
    - List<PromptInfo> updatePrompts
    - ParallelWorkflowData parallelWorkflowData
    - Long timeoutMillis
    - String fallbackSrc
    + getLaunchPrompt() : PromptInfo
    + getModel() : String
    + getRepository() : String
    + getUpdatePrompts() : List<PromptInfo>
    + getParallelWorkflowData() : ParallelWorkflowData
    + isParallelWorkflow() : boolean
    + getTimeoutMillis() : Long
    + getFallbackSrc() : String
  }
  
  class PromptInfo {
    - String srcFile
    - String type
    - String bindResultExp
    + getSrcFile() : String
    + getType() : String
    + getBindResultExp() : String
  }
  
  class SequenceInfo {
    - String model
    - String repository
    - List<PromptInfo> prompts
    - Long timeoutMillis
    - String fallbackSrc
    + getModel() : String
    + getRepository() : String
    + getPrompts() : List<PromptInfo>
    + getTimeoutMillis() : Long
    + getFallbackSrc() : String
  }
  
  class ParallelWorkflowData {
    - PromptInfo parallelPrompt
    - String bindResultType
    - List<SequenceInfo> sequences
    - Long timeoutMillis
    - String fallbackSrc
    + getParallelPrompt() : PromptInfo
    + getBindResultType() : String
    + getSequences() : List<SequenceInfo>
    + getTimeoutMillis() : Long
    + getFallbackSrc() : String
  }
  
  class WorkflowValidator {
    - Logger logger
    + validate(WorkflowData) : boolean
    + validateSequence(SequenceInfo) : boolean
    + validateParallel(ParallelWorkflowData) : boolean
    - ValidationErrorHandler errorHandler
  }
  
  class PmlValidator {
    - Logger logger
    + validate(File) : boolean
    + validateSchema(File) : boolean
    - ValidationErrorHandler errorHandler
  }
  
  class WorkflowParseException {
    + String message
    + Throwable cause
  }
  
  class TimeoutParser {
    + parseToMillis(String) : Long
  }
  
  class ExpressionEvaluator {
    + replaceInputPlaceholder(String, String) : String
    + evaluateExpression(String, Map<String, String>) : String
  }
  
  class BindResultTypeMapper {
    + mapBindResultType(String) : String
  }
  
  enum WorkflowType {
    SEQUENCE
    PARALLEL
  }
}

package "info.jab.churrera.util" {
  class PropertyResolver {
    - Logger logger
    + getProperty(String, String) : Optional<String>
    + getPropertyAsInt(String, String) : Optional<Integer>
  }
  
  class CursorApiKeyResolver {
    - Logger logger
    + resolveApiKey() : String
    - resolveFromEnvironment() : Optional<String>
    - resolveFromFile() : Optional<String>
  }
  
  class PmlConverter {
    - Logger logger
    + toMarkdown(File) : String
    + toMarkdownFromContent(String) : String
    + toMarkdownFromContent(String, String) : String
  }
  
  class ConversationJsonDeserializer {
    + deserialize(JsonParser, DeserializationContext) : ConversationResponse
  }
  
  class ClasspathResolver {
    + resolve(String) : InputStream
  }
}

' Relationships
WorkflowParser --> WorkflowData
WorkflowParser --> PromptInfo
WorkflowParser --> SequenceInfo
WorkflowParser --> ParallelWorkflowData
WorkflowParser --> WorkflowType
WorkflowParser --> TimeoutParser
WorkflowParser ..> WorkflowParseException

WorkflowData --> PromptInfo
WorkflowData --> ParallelWorkflowData
WorkflowData --> SequenceInfo

ParallelWorkflowData --> PromptInfo
ParallelWorkflowData --> SequenceInfo

SequenceInfo --> PromptInfo

WorkflowValidator --> WorkflowData
WorkflowValidator --> SequenceInfo
WorkflowValidator --> ParallelWorkflowData

PmlValidator ..> WorkflowParseException

WorkflowParseException --|> Exception

WorkflowData ..> WorkflowType

@enduml
